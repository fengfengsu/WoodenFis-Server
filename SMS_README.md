# 阿里云短信服务集成说明

## 概述

本项目已集成阿里云短信服务，用于发送手机验证码。支持以下功能：

- 手机号验证码发送
- 5分钟内同一手机号发送限制
- 验证码5分钟有效期
- 开发模式和生产模式支持

## 配置步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 阿里云短信服务配置

#### 2.1 开通阿里云短信服务

1. 登录[阿里云控制台](https://ecs.console.aliyun.com/)
2. 开通短信服务
3. 创建AccessKey（建议使用RAM子账号）
4. 申请短信签名
5. 申请短信模板

#### 2.2 短信模板示例

```
模板名称：验证码短信
模板内容：您的验证码是${code}，5分钟内有效，请勿泄露。
模板类型：验证码
```

### 3. 环境变量配置

复制 `.env.example` 文件为 `.env`：

```bash
cp .env.example .env
```

编辑 `.env` 文件，填入真实配置：

```env
# 阿里云短信服务配置
ALIBABA_CLOUD_ACCESS_KEY_ID=your_access_key_id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your_access_key_secret
SMS_SIGN_NAME=你的短信签名
SMS_TEMPLATE_CODE=SMS_xxxxxxxx
```

## API 接口

### 发送验证码

**接口地址：** `POST /users/send-code`

**请求参数：**
```json
{
    "phone": "13800138000"
}
```

**响应示例：**
```json
{
    "message": "验证码已发送到 13800138000",
    "success": true
}
```

**错误响应：**
- `400`: 手机号格式不正确
- `429`: 请等待5分钟后再次发送验证码
- `500`: 短信发送失败，请稍后重试

### 验证码登录

**接口地址：** `POST /users/login`

**请求参数：**
```json
{
    "phone": "13800138000",
    "code": "123456"
}
```

**响应示例：**
```json
{
    "user": {
        "id": 1,
        "username": "用户8000",
        "phone": "13800138000",
        "is_vip": false,
        "merit_points": 0,
        "created_at": "2024-01-01T00:00:00"
    },
    "message": "登录成功"
}
```

## 开发模式

当未配置阿里云短信服务时，系统会自动进入开发模式：

- 不会真实发送短信
- 在响应中返回生成的验证码（仅用于开发测试）
- 控制台会输出模拟发送日志

## 生产模式

配置完整的阿里云短信服务后，系统会进入生产模式：

- 真实发送短信到用户手机
- 不会在响应中返回验证码
- 记录详细的发送日志

## 安全特性

### 1. 发送频率限制
- 同一手机号5分钟内只能发送一次验证码
- 防止短信轰炸攻击

### 2. 验证码有效期
- 验证码5分钟后自动过期
- 使用后立即失效

### 3. 手机号格式验证
- 严格验证中国大陆手机号格式
- 必须以1开头，共11位数字

### 4. 数据库安全
- 验证码使用后立即标记为已使用
- 新验证码会使旧验证码失效

## 测试

运行短信服务测试：

```bash
python -m pytest test_sms_service.py -v
```

测试覆盖以下场景：
- 成功发送验证码
- 无效手机号处理
- 发送频率限制
- 短信发送失败处理
- 验证码登录（有效/无效/过期）

## 监控和日志

系统会记录以下日志：

- 短信发送成功/失败
- 验证码验证结果
- 频率限制触发
- 异常错误信息

建议在生产环境中配置日志收集和监控告警。

## 故障排除

### 常见问题

1. **短信发送失败**
   - 检查AccessKey配置是否正确
   - 确认短信签名和模板已审核通过
   - 检查账户余额是否充足

2. **验证码收不到**
   - 检查手机号格式是否正确
   - 确认短信模板参数格式正确
   - 查看阿里云短信服务控制台发送记录

3. **频率限制问题**
   - 确认数据库时间设置正确
   - 检查服务器时区配置

### 调试模式

在开发环境中，可以通过以下方式启用详细日志：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 成本优化

- 合理设置发送频率限制
- 监控短信发送量
- 定期清理过期验证码记录
- 考虑使用阿里云短信包套餐

## 扩展功能

未来可以考虑添加：

- 语音验证码支持
- 国际短信支持
- 短信模板动态配置
- 发送统计和分析
- 黑名单管理